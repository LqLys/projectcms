<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Material Design for Bootstrap</title>
    <!-- MDB icon -->
    <link rel="icon" th:href="@{/img/mdb-favicon.ico}" type="image/x-icon">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"/>
    <!-- Material Design Bootstrap -->
    <link rel="stylesheet" th:href="@{/css/mdb.min.css}"/>
    <!-- Your custom styles (optional) -->
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <!-- DataTables CSS -->
    <link rel="stylesheet" th:href="@{/css/addons/datatables.min.css}"/>
    <!-- DataTables JS -->
    <script rel="stylesheet" th:href="@{/js/addons/datatables.min.js}"></script>
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
<div th:replace="common/header :: header"></div>

<div class="container-fluid">
    <div class="row mx-sm-2 my-lg-0">
        <div class="col-12">
            <div class="col-12">
                <h1 th:text="${groupName}"></h1>
            </div>
            <div class="card my-3">
                <div class="card-header">
                    <ul class="nav nav-pills nav-justified">
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/group/details/__${groupId}__/members}">Uczestnicy</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/group/details/__${groupId}__}">Szczegóły</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" th:href="@{/group/details/__${groupId}__/planning}">Planowanie</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/group/details/__${groupId}__/expenses}">Wydatki</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/group/details/__${groupId}__/chat}">Chat</a>
                        </li>
                    </ul>
                </div>

                <div class="card-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-7">
                                <div class="table-wrapper-scroll-y my-custom-scrollbar overflow-auto my-3">
                                    <table class="table bordered table-hover mb-0" id="testTable">
                                        <!-- Table head -->
                                        <thead>
                                        <tr class="table-fixed">
                                            <th>Uczestnik</th>
                                            <th>Rola</th>
                                            <th>Usuń</th>
                                        </tr>
                                        </thead>
                                        <!-- Table head -->

                                        <!-- Table body -->
                                        <tbody>
                                        <input id="userId"
                                               type="hidden"
                                               class="form-control"
                                               th:value="${userId}"/>
                                        <tr th:each="question :${questions}">
                                            <td th:text="${question.text}"></td>
                                            <td th:onclick="'updateAnswer(\'' + ${question.id} + '\');'">
                                                <div th:each="answer :${question.answers}">
                                                    <input type="checkbox" th:value="${answer.id}" th:text="${answer.text}"
                                                    th:name="${'question-answers-' + question.id}" th:checked="${answer.checked}"
                                                    th:class="${'question-answers-' + question.id}"
                                                           th:disabled="${!question.isActive}"
                                                    >
                                                    <span th:text="${answer.answerCount}"></span>

                                                </div>

                                            </td>
                                        </tr>
                                        </tbody>
                                        <!-- Table body -->
                                    </table>
                                    <!-- Table  -->
                                </div>
                            </div>
                            <div class="col-md-5 my-3 px-0">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card mb-3">
                                                <h5 class="card-header blue darken-2 white-text text-center py-2">
                                                    <strong>Dodaj pytanie</strong>
                                                </h5>
                                                <div class="card-body px-lg-5 py-0 ">
                                                    <form autocomplete="off" action="#"
                                                          class="text-center"
                                                          role="form">
                                                        <div class="md-form my-0" id="questionFormDiv">
                                                            <input id="groupId"
                                                                   type="hidden"
                                                                   class="form-control"
                                                                   th:value="${groupId}"/>
                                                            <div class="custom-control">
                                                                <input id="questionInput"
                                                                       type="text"
                                                                       class="form-control"
                                                                       placeholder="*Pytanie"
                                                                />
                                                            </div>
                                                            <div class="custom-control">
                                                                <input id="endDate"
                                                                       type="text"
                                                                       class="form-control"
                                                                       placeholder="*Aktywne do"
                                                                       onfocus="(this.type='date')"
                                                                />
                                                            </div>
                                                            <div class="custom-control">
                                                                <input type="text"
                                                                       placeholder="*Odpowiedź 1"
                                                                       class="form-control addAnswer"
                                                                />
                                                            </div>
                                                            <div class="custom-control">
                                                                <input type="text"
                                                                       placeholder="*Odpowiedź 2"
                                                                       class="form-control addAnswer"
                                                                />
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <button id="createQuestionBtn"
                                                                    type="button"
                                                                    class="btn btn-blue btn-block my-2 waves-effect z-depth-0">
                                                                Zaproś!
                                                            </button>
                                                        </div>
                                                    </form>
                                                    <button id="moreAnswers">More answers</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div th:replace="common/footer :: footer"></div>
        </div>
    </div>
</div>
<script>

    function updateAnswer(questionId) {
        const userId = $('#userId').val();
        const inputsName = "question-answers-" + questionId;
        const questionAnswers = $('.'+inputsName);
        const ansIds = [];
        for(var i = 0; i < questionAnswers.length; i++){
            if(questionAnswers[i].checked === true){
                ansIds.push(questionAnswers[i].value);
            }
        }
        var payload = {
            userId: userId,
            questionId: questionId,
            answerIds: ansIds
        };
        $.ajax({
            url: 'http://localhost:8080/api/answer/vote',
            data: JSON.stringify(payload),
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            success: function (result) {
                console.log('Form sent');
                location.reload();
            },
            error: function (error) {
                location.reload();
                console.log('Error sending form')
            }
        });

    }




    function addNewAnswer() {
        const questionFormDiv = $('#questionFormDiv');
        const answers = $('.addAnswer');
        const ans0 = $(answers[0]);
        let cloned = ans0.clone();
        cloned.val('');
        const ansCount = answers.length;
        cloned.attr('placeholder', '*Odpowiedź ' + (ansCount + 1));
        const wrapperDiv = $("<div class='custom-control'></div>");
        wrapperDiv.append(cloned[0]);
        questionFormDiv.append(wrapperDiv);
    }

    $('#moreAnswers').on('click', addNewAnswer);


    function createQuestion() {
        const answerInputs = jQuery.makeArray($('.addAnswer'));
        const answers = answerInputs.map(ans => ans.value);
        const questionText = $('#questionInput').val();
        const groupId = $('#groupId').val();
        const endDate = $('#endDate').val();
        console.log(questionText);
        console.log(answers);
        const question = {
            text: questionText,
            answers: answers,
            groupId: groupId,
            endDate: endDate
        };

        $.ajax({
            url: 'http://localhost:8080/api/question/add',
            data: JSON.stringify(question),
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            success: function (result) {
                console.log('Form sent');
                location.reload();
            },
            error: function (error) {
                location.reload();
                console.log('Error sending form')
            }
        });

    }
    $('#createQuestionBtn').on('click', createQuestion);


</script>

</body>
</html>
