<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <title>Registration Form</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Material Design for Bootstrap</title>
    <!-- MDB icon -->
    <link rel="icon" th:href="@{/img/mdb-favicon.ico}" type="image/x-icon">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"/>
    <!-- Material Design Bootstrap -->
    <link rel="stylesheet" th:href="@{/css/mdb.min.css}"/>
    <!-- Your custom styles (optional) -->
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <!-- DataTables CSS -->
    <link rel="stylesheet" th:href="@{/css/addons/datatables.min.css}"/>
    <!-- DataTables JS -->
    <script rel="stylesheet" th:href="@{/js/addons/datatables.min.js}" ></script>
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="/js/js.js"></script>
    <script src="/js/stomp.js"></script>
</head>
<body>
<div th:replace="common/header :: header"></div>
<div class="container">
    <div class="row">
        <h2>Wyjazd Integracyjny</h2>
    </div>
    <div class="row">
        <div>
            <ul class="nav nav-pills nav-justified">
                <h3 class="pr-5 mb-0 mr-5" th:text="${groupName}"></h3>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/group/details/__${groupId}__/members}">Uczestnicy</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " th:href="@{/group/details/__${groupId}__}">Szczegóły</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/group/details/__${groupId}__/planning}">Planowanie</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/group/details/__${groupId}__/expenses}">Wydatki</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active"  th:href="@{/group/details/__${groupId}__/chat}">Chat</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-8">
            <h3 th:text="${groupName + ' czat'}"></h3>
            <div>
                <!--<label>User:</label>-->
                <!--<input id="user" type="text"/><br>-->

                <label>You message:</label>
                <input id="messageToSend" type="text"/><br>

                <button id="sendBtn">Send</button>
                <div id="all-messages">
                    <p th:each="msg: ${messages}" th:text="${msg.author + ': ' + msg.message}"></p>
                </div>
            </div>
        </div>
        <div class="col-sm-4">

        </div>
    </div>
</div>

<div th:replace="common/footer :: footer"></div>


<script th:inline="javascript">
    $( document ).ready(function(){
        var grId = /*[[${groupId}]]*/ "";
        var username =/*[[${username}]]*/ "";
        var apiBase = /*[[${apiBase}]]*/ "";
        var indexOfUrl = apiBase.indexOf('/');
        var wsUrl = apiBase.slice(indexOfUrl);
        var client = null;
        var color;

        function showMessage(value, user, userColor) {
            var newResponse = document.createElement('p');
            newResponse.style.color = userColor;
            newResponse.appendChild(document.createTextNode(user));
            newResponse.appendChild(document.createTextNode(": "));
            newResponse.appendChild(document.createTextNode(value));
            var respone = document.getElementById('all-messages');
            respone.appendChild(newResponse);
        }
        function connect(id) {

            client = Stomp.client('ws:'+ wsUrl + '/chat');
            color = getRandomColor();
            client.connect({}, function (frame) {
                client.subscribe("/topic/messages/"+id, function(message){
                    showMessage(JSON.parse(message.body).value, JSON.parse(message.body).user, JSON.parse(message.body).userColor)
                });
            })
        }
        function sendMessage() {
            var messageToSend = document.getElementById('messageToSend').value;
            // var user = document.getElementById('user').value;
            client.send("/app/chat/"+grId, {}, JSON.stringify({'value': messageToSend, 'user': username, 'userColor': color}) );
            document.getElementById('messageToSend').value = "";
        }
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        $('#sendBtn').on('click', sendMessage);
        connect(grId);
    })



    // var apiBase = /*[[${apiBase}]]*/ "";
    // setInterval(function(){
    //     $.get(apiBase +"/message/group/1", function(data, status){
    //         console.log(data);
    //         var tbody =  $('tbody');
    //         tbody.empty();
    //         for (var i = 0; i < data.length; i++) {
    //             var tr = $("<tr></tr>");
    //             var timeTd = $("<td></td>").text(data[i].time);
    //             var auth = $("<td></td>").text(data[i].author);
    //             var msgTd = $("<td></td>").text(data[i].message);
    //             tr.append(timeTd);
    //             tr.append(auth);
    //             tr.append(msgTd);
    //             tbody.append(tr);
    //         }
    //     });
    // }, 3000);




</script>

</body>
</html>
